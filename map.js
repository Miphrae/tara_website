document.addEventListener("DOMContentLoaded",(()=>{const e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}),t=(L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Tiles &copy; Esri"}),"fX3Uesvx5ZBwgI8zNqhf"),n=(L.tileLayer(`https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=${t}`,{tileSize:512,zoomOffset:-1,minZoom:1,attribution:'<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',crossOrigin:!0}),L.tileLayer(`https://api.maptiler.com/maps/hybrid/style.json?key=${t}`,{tileSize:512,zoomOffset:-1,minZoom:1,attribution:'<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',crossOrigin:!0}),L.map("map",{layers:[e]}).setView([37.5,-119.5],6)),r=document.querySelectorAll("#county-tabs button"),o=document.getElementById("search-toggle"),s=document.getElementById("org-search"),a=document.getElementById("search-results"),i=document.getElementById("sidebar"),l={county1:{kml:"https://cdn.jsdelivr.net/gh/miphrae/tara_website@v1.0.0/borders_livermore.kml",csv:"https://cdn.jsdelivr.net/gh/miphrae/tara_website@v1.0.0/points_livermore.csv"},county2:{kml:"https://cdn.jsdelivr.net/gh/miphrae/tara_website@v1.0.0/borders_pleasanton.kml",csv:"https://cdn.jsdelivr.net/gh/miphrae/tara_website@v1.0.0/points_pleasanton.csv"},county3:{kml:"https://cdn.jsdelivr.net/gh/miphrae/tara_website@v1.0.0/borders.kml",csv:"https://cdn.jsdelivr.net/gh/miphrae/tara_website@v1.0.0/points.csv"}};let c=null,p=L.markerClusterGroup(),d=[];function m(e){return L.divIcon({html:`\n        <svg width="24" height="36" viewBox="0 0 24 36">\n          <path d="M12 0C7.038 0 3 4.038 3 9\n                   c0 7.5 9 27 9 27s9-19.5 9-27\n                   C21 4.038 16.962 0 12 0z"\n                fill="${e}"/>\n          <circle cx="12" cy="9" r="3" fill="#fff"/>\n        </svg>`,className:"",iconSize:[24,36],iconAnchor:[12,36],popupAnchor:[0,-36]})}const y=m("#0074D9"),h=m("#FF4136");async function g(e){c&&n.removeLayer(c),p.clearLayers(),d=[],i.innerHTML="<p><em>Click a marker on the map â†’ its name will go here.</em></p>",c=await new Promise((t=>{omnivore.kml(l[e].kml,null,L.geoJson(null,{style:{color:"#0074D9",weight:2,opacity:.8}})).on("ready",(function(){n.fitBounds(this.getBounds()),this.addTo(n),t(this)}))}));const t=await fetch(l[e].csv).then((e=>e.text())),r=Papa.parse(t,{header:!0}).data;for(let e of r){if(!e.LAT||!e.LON)continue;const t=e["Organization Name_CLEAN"],n=[+e.LAT,+e.LON],r="multiple spaces"===(e.isMultiple||"").toLowerCase()?h:y,o=L.marker(n,{title:t,icon:r});o.bindPopup(`<strong>${t}</strong><br>${e.Address}`),o.on("click",(()=>{i.innerHTML=`<h4>${t}</h4><p>${e.Address}</p>`})),p.addLayer(o),d.push({name:t,marker:o})}n.addLayer(p)}r.forEach((e=>{e.addEventListener("click",(()=>{r.forEach((e=>e.classList.remove("active"))),e.classList.add("active"),g(e.dataset.county)}))})),g("county1"),o.addEventListener("click",(()=>{"1"===s.style.opacity?(s.style.width="0",s.style.opacity="0",a.style.display="none"):(s.style.width="200px",s.style.opacity="1",s.focus())})),s.addEventListener("input",(()=>{const e=s.value.trim().toLowerCase();if(a.innerHTML="",!e)return void(a.style.display="none");let r=d.filter((t=>t.name.toLowerCase().includes(e)||t.marker.getPopup().getContent().toLowerCase().includes(e))).slice(0,10);r.length?(r.forEach((e=>{const t=document.createElement("div");t.textContent=e.name,t.onclick=()=>{n.setView(e.marker.getLatLng(),14),e.marker.openPopup(),a.style.display="none",s.value=e.name},a.appendChild(t)})),a.style.display="block"):console.log("Fallback");const o=`https://api.maptiler.com/geocoding/${encodeURIComponent(e)}.json?key=${t}&limit=5`;console.log("MapTiler fallback URL:",o),fetch(o).then((e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()})).then((e=>{const t=Array.isArray(e.features)?e.features:[];if(0===t.length)return console.log("No MapTiler results"),void(a.style.display="none");t.slice(0,5).forEach((e=>{const t=e.place_name;console.log(t);const[r,o]=e.geometry.coordinates,i=document.createElement("div");i.textContent=t,i.style.padding="0.3rem",i.style.cursor="pointer",i.addEventListener("click",(()=>{n.setView([o,r],14),L.popup().setLatLng([o,r]).setContent(`<strong>Address:</strong><br>${t}`).openOn(n),a.style.display="none",s.value=t})),a.appendChild(i)})),a.style.display="block"})).catch((e=>{console.error("MapTiler geocode error:",e),a.style.display="none"}))})),document.addEventListener("click",(e=>{s.contains(e.target)||o.contains(e.target)||(a.style.display="none")}))}));